# Парсер данных с тел. станции

## Описание
Парсинг данных осуществляется со стации **nec** по протоколу **SMDR** 

Парсер работает в постоянном режиме, демоном (службой).

## Команды управления

### Проверка состояния
`systemctl -l status phone`

Если все работает нормально, в консоли отобразиться:

![статус](/description/status.png)

Так же проверить работоспособность можно выполнив комманду:
`ps -aux | grep nec`

### Запуск парсера
`systemctl start phone`

### Остановка парсера
`systemctl stop phone`

### Перезапуск
`systemctl restart phone`

## База данных
В качестве хранения данных используется nosql субд **mongodb**.

Созданно две коллекции (таблицы):
- calls - тел. звонки
- phones - список тел. станций.

В коллеции `phones` присутствует поле enabled, если его переключить в `false` - 
данные по этой станции обрабатываться не будут.

**Важно** - для применения изменений - сервис нужно перезапустить: `systemctl restart phone`

## Мониторинг
Парсер постоянно мониторятся заббиксом.

Заббикс раз в **60** секунд смотрит запущен ли процесс парсера. 
Если процесс не запущен - посылает эл.письмо.

Так же парсер пишет информацию в лог файл.
`/var/log/phone.log`

![логирование](/description/log.png)

Смотреть в режиме реального времени командой: 
`tail -f /var/log/phone.log`

Настроена ротация логов: когда лог достигает размера `10Мб` - он архивируется. 
Хранится последние 10 архивов. 

Архивы вида **phone.log.(номер).gz**, где *номер* - порядковый номер.

## Дополнительно

Так же парсер пушит сообщения в **redis** сервер. 
Подписаться на сообщения можно любым клиентом редис (Pub/Sub).

Из консоли, со своего компьютера, это будет так:
`redis-cli -h 10.39.0.113`

Затем подписаться на канал phones:

`SUBSCRIBE phones`

Сообщения пойдут в json формате.